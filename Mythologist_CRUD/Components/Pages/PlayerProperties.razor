@page "/playerproperties"
@attribute [StreamRendering(true)]
@using Mythologist_CRUD.Components.Layout
@using SharedLogic.Services
@using SharedLogic.Model
@using Mythologist_CRUD.Components.Components

@inject Blazored.SessionStorage.ISessionStorageService sessionStorage
@inject IConfiguration configuration
@inject ISnackbar snackBar
@inject IDatabaseConnectionService dbConnection;
@inject NavigationManager navManager;

<MudContainer MaxWidth="MaxWidth.Medium">
	<MudText Typo="Typo.h4" Class="mb-4">Player Properties</MudText>
	<MudStack Spacing="10">
		<MudText Typo="Typo.body1" Align="Align.Left">
			Assign properties to players that can be used to trigger events.
		</MudText>
		<PlayerPropertiesDataGrid PlayerProperties="@playerProperties"></PlayerPropertiesDataGrid>
		<MudButton @onclick="SubmitProperties" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto">Save</MudButton>
	</MudStack>
</MudContainer>

@code {

	[CascadingParameter]
	public MainLayout? Layout { get; set; }

	private string? gameName = null;
	private string? GMPassword = null;

	private PlayerPropertiesModel playerProperties = new PlayerPropertiesModel();

	// Due to pre-rendering in Blazor Server you can't perform any JS interop until the OnAfterRender lifecycle method.
	// Taken from the SessionStorage docs, unknown if this is relevent to other stuff.
	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender){
			(gameName, GMPassword) = await Utils.Utils.PageSetup(sessionStorage, Layout!, dbConnection, navManager, snackBar);
			playerProperties = await dbConnection.PlayerProperties(gameName);
			StateHasChanged();
		}
	}

	private void SubmitProperties() {
		if (gameName == null) {
			snackBar.Add("Unexpected null gameName");
			return;
		}

		dbConnection.UpdatePlayerProperties(gameName, playerProperties);
		snackBar.Add("Properties Saved", Severity.Success);
	}
}